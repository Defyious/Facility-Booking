name: Secret Scanning Gate

on:
  push:
    branches: [main]
  pull_request:

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Check for open secret scanning alerts
        id: scan
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          REPO: ${{ github.repository }}
        run: |
          echo "üîç Calling GitHub Secret Scanning Alerts API for $REPO..."

          # Simulated response (real use would be a curl call)
          response='[
            {
              "number": 1,
              "created_at": "2020-11-06T18:18:30Z",
              "url": "https://api.github.com/repos/owner/repo/secret-scanning/alerts/1",
              "html_url": "https://github.com/owner/repo/security/secret-scanning/1",
              "secret_type": "mailchimp_api_key",
              "secret_type_display_name": "Mailchimp API Key",
              "state": "open"
            }
          ]'

          echo "üì¶ Raw API Response:"
          cat "$api_response"
          echo ""

          # Fail if status code is not 200
          if [ "$status_code" -ne 200 ]; then
            echo "‚ùå API call failed with status code $status_code"
            exit 1
          fi

          # Count and handle open secrets
          open_count=$(jq 'length' < "$api_response")
          if [ "$open_count" -gt 0 ]; then
            echo "‚ùå $open_count open secret scanning alerts found. Failing the workflow."
            exit 1
          else
            echo "‚úÖ No open secrets found."
          fi
